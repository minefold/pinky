#!/usr/bin/env ruby

# restore-dir <remote-file>

# restore-dir s3://minefold-production/worlds/501042431376850800000031/world-data.incremental.tar

# will download and extract archive to current directory based on file extension
# handles tar|tar.gz|tar.lzo
# ex. restore-file

S3CURL = File.expand_path File.join __FILE__, '../s3curl'

REMOTE = ARGV.shift
if !(REMOTE =~ /s3:\/\/([\w-]+)\/(.*)/)
  abort "usage: #{$0} <remote-file>"
end

bucket, key = $1, $2

if File.basename(key) =~ /tar\.?(\w+)?$/
  ext = $1
  decompression = case ext
  when 'gz'
    'tar xz'
  when 'lzo'
    'lzop -d | tar x'
  else
    'tar x'
  end
else
  abort "unsupported decompression format for #{key}"
end

def run cmd
  $stderr.puts cmd
  success = system cmd
  raise "Failed: '#{cmd}'" unless success
end

run "#{S3CURL} -- https://#{bucket}.s3.amazonaws.com/#{key} --silent --show-error | #{decompression}"
